<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NodeMCU and MQTT protocol | Geek Instructables</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.24fd4a51.css" as="style"><link rel="preload" href="/assets/js/app.5ee03c05.js" as="script"><link rel="preload" href="/assets/js/2.d5fc9d08.js" as="script"><link rel="preload" href="/assets/js/10.e6fa0f2d.js" as="script"><link rel="prefetch" href="/assets/js/11.cf247f02.js"><link rel="prefetch" href="/assets/js/12.de54b797.js"><link rel="prefetch" href="/assets/js/13.29ff9bc7.js"><link rel="prefetch" href="/assets/js/3.807373b6.js"><link rel="prefetch" href="/assets/js/4.c85fc935.js"><link rel="prefetch" href="/assets/js/5.7110d665.js"><link rel="prefetch" href="/assets/js/6.d5b4cdd8.js"><link rel="prefetch" href="/assets/js/7.f6b6b50d.js"><link rel="prefetch" href="/assets/js/8.8a89244c.js"><link rel="prefetch" href="/assets/js/9.17b456e0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.24fd4a51.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Geek Instructables</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/jesusgn90/geek-instructables" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/jesusgn90/geek-instructables" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Geek Instructables</a></li><li><a href="/exclude-branch-github-action/" class="sidebar-link">Exclude branch in GitHub action</a></li><li><a href="/expose-local-service/" class="sidebar-link">Expose local service (SSH tunnel)</a></li><li><a href="/nodemcu-bmp280/" class="sidebar-link">NodeMCU reading barometric pressure sensor</a></li><li><a href="/nodemcu-connect-mqtt/" class="active sidebar-link">NodeMCU and MQTT protocol</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/nodemcu-connect-to-wifi/" class="sidebar-link">NodeMCU connect to Wi-Fi</a></li><li><a href="/nodemcu-deep-sleep/" class="sidebar-link">NodeMCU deep sleep mode</a></li><li><a href="/nodemcu-i2c-lcd/" class="sidebar-link">NodeMCU using LCD screen through I2C</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><!----> <h1 id="nodemcu-and-mqtt-protocol"><a href="#nodemcu-and-mqtt-protocol" class="header-anchor">#</a> NodeMCU and MQTT protocol</h1> <blockquote><p>MQTT (MQ Telemetry Transport or Message Queuing Telemetry Transport) is an open OASIS and ISO standard (ISO/IEC 20922) lightweight, publish-subscribe network protocol that transports messages between devices.</p></blockquote> <p>Recommended reading: <a href="https://en.wikipedia.org/wiki/MQTT" target="_blank" rel="noopener noreferrer">MQTT (Wikipedia)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="how-it-works"><a href="#how-it-works" class="header-anchor">#</a> How it works</h3> <p>We have three main actors:</p> <ul><li>There is a <em>broker</em> server, which handles the messages from any client configured to use this broker server.</li> <li>A client (or more than one) which <em>publishes</em> messages related to certain <em>topics</em>.</li> <li>A client (or more than one) which <em>subscribes</em> to one or more <em>topics</em>.</li></ul> <p>Essentially, we can see this very similar to some social networks, you send a message including a hashtag (the topic) with some content (the message). Someone else, filters messages that include your hashtag (topic) and read the messages. But you actually don't care about the other person.</p> <img src="/nodemcu-connect-mqtt/example.png" height="auto" width="100%" class="image-center"> <p><em>Image credits: <a href="https://www.electronics-lab.com/community/index.php?/topic/47715-realtek-ameba-rtl8195-mqtt-demo/" target="_blank" rel="noopener noreferrer">https://www.electronics-lab.com/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p> <h3 id="configure-mosquitto-as-broker-server-and-test-it"><a href="#configure-mosquitto-as-broker-server-and-test-it" class="header-anchor">#</a> Configure Mosquitto as broker server and test it</h3> <p>Install <code>mosquitto</code> and <code>mosquitto-clients</code> in the broker server:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y mosquitto mosquitto-clients
</code></pre></div><p>Configure a simple broker server:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">cat</span> /etc/mosquitto/mosquitto.conf 

<span class="token comment"># Default settings</span>
pid_file /var/run/mosquitto.pid
persistence <span class="token boolean">true</span>
persistence_location /var/lib/mosquitto/
log_dest <span class="token function">file</span> /var/log/mosquitto/mosquitto.log
include_dir /etc/mosquitto/conf.d

<span class="token comment"># Added settings</span>
listener <span class="token number">1884</span>
allow_anonymous <span class="token boolean">true</span>
</code></pre></div><p>Now, in a different machine, install <code>mosquitto-clients</code>:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y mosquitto-clients
</code></pre></div><p>From the broker server, subscribe to the topic <code>testTopic</code>:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ mosquitto_sub  -v -t testTopic -p <span class="token number">1884</span>
</code></pre></div><p>From the other machine, try to publish a message:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ mosquitto_pub -t testTopic -m <span class="token string">&quot;Test message&quot;</span> -p <span class="token number">1884</span>
</code></pre></div><p>The broker server should print this:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>testTopic Test message
</code></pre></div><p><em>Note: we are using the broker server to subscribe too, but it doesn't need to be the same machine, this is just for simplicity.</em></p> <h3 id="minimal-sketch"><a href="#minimal-sketch" class="header-anchor">#</a> Minimal sketch</h3> <p>Both the NodeMCU and the broker server must be connected to the same network, that's why we are going to connect our NodeMCU to a Wi-Fi network.</p> <p>Let's see the full sketch first:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ESP8266WiFi.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;PubSubClient.h&gt;</span></span>

<span class="token comment">// Broker port</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MQTT_PORT 1884</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BAUD_RATE 9600</span>

<span class="token comment">// Update these with values suitable for your network.</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ssid <span class="token operator">=</span> <span class="token string">&quot;SSID&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> password <span class="token operator">=</span> <span class="token string">&quot;WIFI_PASS&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Broker address (Raspberry Pi address)</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mqtt_server <span class="token operator">=</span> <span class="token string">&quot;192.168.1.132&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Publish topic</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> publish_topic <span class="token operator">=</span> <span class="token string">&quot;outTopic&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Subscribe topic</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> subscribe_topic <span class="token operator">=</span> <span class="token string">&quot;inTopic&quot;</span><span class="token punctuation">;</span>

WiFiClient espClient<span class="token punctuation">;</span>
PubSubClient <span class="token function">client</span><span class="token punctuation">(</span>espClient<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setup_wifi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// We start by connecting to a WiFi network</span>
  WiFi<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>ssid<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>WiFi<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> WL_CONNECTED<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Logic for arrived messages</span>
<span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>topic<span class="token punctuation">,</span> byte <span class="token operator">*</span>payload<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Message arrived [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;] &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>payload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// Loop until we're reconnected</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// Create a random client ID</span>
    String clientId <span class="token operator">=</span> <span class="token string">&quot;ESP8266Client-&quot;</span><span class="token punctuation">;</span>
    clientId <span class="token operator">+=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>clientId<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>subscribe_topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Wait 5 seconds before retrying</span>
      <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>BAUD_RATE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Configure Wi-Fi connection</span>
  <span class="token function">setup_wifi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Configure broker server</span>
  client<span class="token punctuation">.</span><span class="token function">setServer</span><span class="token punctuation">(</span>mqtt_server<span class="token punctuation">,</span> MQTT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set callback for arrived messages</span>
  client<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// Connect the MQTT client</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  client<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>publish_topic<span class="token punctuation">,</span> <span class="token string">&quot;test message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="how-the-above-sketch-works"><a href="#how-the-above-sketch-works" class="header-anchor">#</a> How the above sketch works</h4> <p>First of all, we include the required libraries:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ESP8266WiFi.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;PubSubClient.h&gt;</span></span>
</code></pre></div><p>Now we declare some constant values and declare the clients:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// Broker port</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MQTT_PORT 1884</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BAUD_RATE 9600</span>

<span class="token comment">// Update these with values suitable for your network.</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ssid <span class="token operator">=</span> <span class="token string">&quot;SSID&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> password <span class="token operator">=</span> <span class="token string">&quot;WIFI_PASS&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Broker address (Raspberry Pi address)</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mqtt_server <span class="token operator">=</span> <span class="token string">&quot;192.168.1.132&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Publish topic</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> publish_topic <span class="token operator">=</span> <span class="token string">&quot;outTopic&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Subscribe topic</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> subscribe_topic <span class="token operator">=</span> <span class="token string">&quot;inTopic&quot;</span><span class="token punctuation">;</span>

WiFiClient espClient<span class="token punctuation">;</span>
PubSubClient <span class="token function">client</span><span class="token punctuation">(</span>espClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Notes:</p> <ul><li><code>192.168.1.132</code> must the be the broker server address.</li> <li><code>outTopic</code> will be the used topic for publishing messages, those that the NodeMCU will send.</li> <li><code>inTopic</code> will be the topic used for subscribing messages, those that we want to read in the NodeMCU.</li></ul> <p>The <code>setup_wifi</code> function is a helper function to connect to the Wi-Fi network.</p> <p>Recommended reading: <a href="https://geekinstructables.com/nodemcu-connect-to-wifi/" target="_blank" rel="noopener noreferrer">NodeMCU connect to Wi-Fi<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>The <code>callback</code> function will be executed whenever the NodeMCU any message to any topic that it's subscribed to.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// Logic for arrived messages</span>
<span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>topic<span class="token punctuation">,</span> byte <span class="token operator">*</span>payload<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Message arrived [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;] &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>payload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>reconnect</code> function is a helper function to connect the NodeMCU to the MQTT broker server.</p> <p>Inside the <code>setup</code> function we connect to the Wi-Fi network, configure the MQTT broker server and configure the arrived messages callback.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>BAUD_RATE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Configure Wi-Fi connection</span>
  <span class="token function">setup_wifi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Configure broker server</span>
  client<span class="token punctuation">.</span><span class="token function">setServer</span><span class="token punctuation">(</span>mqtt_server<span class="token punctuation">,</span> MQTT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set callback for arrived messages</span>
  client<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally, the <code>loop</code> function checks if our MQTT client is already connected (the first time it won't be connected), if it's not connected, it calls <code>reconnect</code>. Then, it invokes the internal client <code>loop</code> and then it publish a message using the <code>outTopic</code> topic and <code>test message</code> as content.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// Connect the MQTT client</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  client<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>publish_topic<span class="token punctuation">,</span> <span class="token string">&quot;test message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="read-the-messages-sent-by-the-nodemcu-in-our-computer"><a href="#read-the-messages-sent-by-the-nodemcu-in-our-computer" class="header-anchor">#</a> Read the messages sent by the NodeMCU in our computer</h3> <p>Using the above sketch, our NodeMCU will a message every 2 seconds using the <code>outTopic</code> topic and <code>test message</code> as content for the message.</p> <p>Subscribe to <code>outTopic</code> topic in your computer:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ mosquitto_sub  -v -t outTopic -p <span class="token number">1884</span>
</code></pre></div><p>Now you should start to see this ever two seconds:</p> <div class="language- extra-class"><pre class="language-text"><code>outTopic test message
outTopic test message
outTopic test message
outTopic test message
...
</code></pre></div><h3 id="read-the-messages-sent-by-our-computer-in-our-nodemcu"><a href="#read-the-messages-sent-by-our-computer-in-our-nodemcu" class="header-anchor">#</a> Read the messages sent by our computer in our NodeMCU</h3> <p>Using the above sketch, our NodeMCU is subscribed to messages from <code>inTopic</code> topic, so if you send a message using that topic from any machine connected to the broker server, you'll see that message in the serial monitor of your NodeMCU.</p> <p>To send a message from your computer:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ mosquitto_pub -t inTopic -m <span class="token string">&quot;Test message from computer&quot;</span> -p <span class="token number">1884</span>
</code></pre></div><!----></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5ee03c05.js" defer></script><script src="/assets/js/2.d5fc9d08.js" defer></script><script src="/assets/js/10.e6fa0f2d.js" defer></script>
  </body>
</html>
