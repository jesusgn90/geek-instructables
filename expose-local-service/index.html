<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Expose local service (SSH tunnel) | Geek Instructables</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.24fd4a51.css" as="style"><link rel="preload" href="/assets/js/app.5ee03c05.js" as="script"><link rel="preload" href="/assets/js/2.d5fc9d08.js" as="script"><link rel="preload" href="/assets/js/8.8a89244c.js" as="script"><link rel="prefetch" href="/assets/js/10.e6fa0f2d.js"><link rel="prefetch" href="/assets/js/11.cf247f02.js"><link rel="prefetch" href="/assets/js/12.de54b797.js"><link rel="prefetch" href="/assets/js/13.29ff9bc7.js"><link rel="prefetch" href="/assets/js/3.807373b6.js"><link rel="prefetch" href="/assets/js/4.c85fc935.js"><link rel="prefetch" href="/assets/js/5.7110d665.js"><link rel="prefetch" href="/assets/js/6.d5b4cdd8.js"><link rel="prefetch" href="/assets/js/7.f6b6b50d.js"><link rel="prefetch" href="/assets/js/9.17b456e0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.24fd4a51.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Geek Instructables</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/jesusgn90/geek-instructables" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/jesusgn90/geek-instructables" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Geek Instructables</a></li><li><a href="/exclude-branch-github-action/" class="sidebar-link">Exclude branch in GitHub action</a></li><li><a href="/expose-local-service/" class="active sidebar-link">Expose local service (SSH tunnel)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/nodemcu-bmp280/" class="sidebar-link">NodeMCU reading barometric pressure sensor</a></li><li><a href="/nodemcu-connect-mqtt/" class="sidebar-link">NodeMCU and MQTT protocol</a></li><li><a href="/nodemcu-connect-to-wifi/" class="sidebar-link">NodeMCU connect to Wi-Fi</a></li><li><a href="/nodemcu-deep-sleep/" class="sidebar-link">NodeMCU deep sleep mode</a></li><li><a href="/nodemcu-i2c-lcd/" class="sidebar-link">NodeMCU using LCD screen through I2C</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><!----> <h1 id="expose-local-service-ssh-tunnel"><a href="#expose-local-service-ssh-tunnel" class="header-anchor">#</a> Expose local service (SSH tunnel)</h1> <p>Somehow, you need to expose a local service to the Internet such a webservice running in a Raspberry Pi. However, you are not able
to do it on usual ways such as static IP address or DynDNS due to whatever reason or simply, you just want to make your own <a href="https://ngrok.com/" target="_blank" rel="noopener noreferrer">Ngrok<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> like system.</p> <h3 id="requirements"><a href="#requirements" class="header-anchor">#</a> Requirements</h3> <ul><li>Device with the webservice expected to be exposed. For our example, a Raspberry Pi 3B+ with Internet access connected to our router (it's in our local network). About $35.</li> <li>External server with static address. For our example, an AWS t2.nano instance with Ubuntu server 18.04 installed. About $5/month.</li> <li>Custom domain, for our example, example.com</li> <li>Optionally, you may want to use a laptop to make things from here using SSH, but you don't really need it.</li> <li>A little bit of Linux and networking knowledge.</li></ul> <h3 id="server-aws-t2-nano-instance"><a href="#server-aws-t2-nano-instance" class="header-anchor">#</a> Server | AWS t2.nano instance</h3> <p>Security groups:</p> <ul><li>Inbound
<ul><li>HTTP/TCP 80 from everywhere (0.0.0.0)</li> <li>SSH/TCP 22 from everywhere (0.0.0.0)</li></ul></li> <li>Outbound
<ul><li>All</li></ul></li></ul> <h4 id="install-nginx"><a href="#install-nginx" class="header-anchor">#</a> Install NGINX</h4> <p>Update the apt packages, install NGINX, enable the NGINX service, start the NGINX service.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">apt</span> update
$ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> nginx
$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> nginx
$ <span class="token function">sudo</span> systemctl start nginx
</code></pre></div><h4 id="configure-nginx"><a href="#configure-nginx" class="header-anchor">#</a> Configure NGINX</h4> <p>Create a server file to listen to our subdomain on port 80 (default):</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">touch</span> /etc/nginx/sites-enabled/example-server
</code></pre></div><p>Use a text editor such as <code>vi</code> or <code>nano</code> and copy and paste the next configuration, once done, save and exit:</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token comment"># Our subdomain, change with your own</span>
    <span class="token keyword">server_name</span> foo<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

    <span class="token comment"># Log file location</span>
    <span class="token keyword">access_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token variable">$host</span><span class="token punctuation">;</span>

    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token comment"># Where to send incoming requests</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">3334</span><span class="token operator">/</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>

        <span class="token comment"># Next two lines allow to proxy websocket connections :)</span>
        <span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> Connection <span class="token string">&quot;Upgrade&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">error_page</span> <span class="token number">502</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
    <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html <span class="token punctuation">{</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Our NGINX is now redirecting every request coming from <code>foo.example.com</code> port <code>80</code> to <code>http://localhost:3334</code>.</p> <h4 id="configure-domain-and-subdomain"><a href="#configure-domain-and-subdomain" class="header-anchor">#</a> Configure domain and subdomain</h4> <p>Point both <code>example.com</code> and <code>foo.example.com</code> to the AWS instance address. For our example, the instance address is <code>1.1.1.1</code>. How to do it mainly depends on your domain provider but essentially you should see the next entries on your DNS configuration:</p> <div class="language- extra-class"><pre class="language-text"><code>example.com       A   1.1.1.1
foo.example.com   A   1.1.1.1
</code></pre></div><p>That's two <code>A</code> entries pointing to <code>1.1.1.1</code>.</p> <p>At this point, and if the DNS are working properly, you can visit <code>foo.example.com</code> on your browser and you should see a NGINX error (502 or 404), but this is good, our NGINX is properly handling our request from our subdomain.</p> <h4 id="create-a-limited-user"><a href="#create-a-limited-user" class="header-anchor">#</a> Create a limited user</h4> <p>Since we don't want to use an administrator user for our tunnels, let's create a limited user, for our example, the user will be <code>tunnel</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">useradd</span> -m tunnel -s /bin/false
</code></pre></div><p>Prepare the <code>.ssh</code> directory for the user <code>tunnel</code>:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">mkdir</span> /home/tunnel/.ssh
$ <span class="token function">sudo</span> <span class="token function">touch</span> /home/tunnel/.ssh/authorized_keys
</code></pre></div><h3 id="client-raspberry-pi-3b"><a href="#client-raspberry-pi-3b" class="header-anchor">#</a> Client | Raspberry PI 3B+</h3> <h4 id="create-ssh-key-pair"><a href="#create-ssh-key-pair" class="header-anchor">#</a> Create SSH key pair</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>$ ssh-keygen -t rsa -b <span class="token number">4096</span> -C <span class="token string">&quot;your_email@example.com&quot;</span>
</code></pre></div><p>When asked, save your key pair in <code>/home/&lt;raspberry-pi-user&gt;/.ssh/id_rsa_tunnel_example_com</code>. Now you should see the key pair:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">ls</span> /home/<span class="token operator">&lt;</span>raspberry-pi-user<span class="token operator">&gt;</span>/.ssh
id_rsa_tunnel_example_com
id_rsa_tunnel_example_com.pub
</code></pre></div><p>Copy the public key to the authorized keys in your server:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Copy this</span>
$ <span class="token function">cat</span> /home/<span class="token operator">&lt;</span>raspberry-pi-user<span class="token operator">&gt;</span>/.ssh/id_rsa_tunnel_example_com.pub 
</code></pre></div><p>Now, in your server (the AWS instance):</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Open authorized_keys and append your public key from the Raspberry</span>
$ <span class="token function">sudo</span> <span class="token function">nano</span> /home/tunnel/.ssh/authorized_keys
</code></pre></div><p>There are plenty of ways to do the copy &amp; paste, but this is easy to do for any kind of user.</p> <h4 id="create-a-systemd-dynamic-service"><a href="#create-a-systemd-dynamic-service" class="header-anchor">#</a> Create a systemd dynamic service</h4> <p>Create the service file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">touch</span> /etc/systemd/system/secure-tunnel@.service
</code></pre></div><p>Open the created file and paste the next lines:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">nano</span> /etc/systemd/system/secure-tunnel@.service
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Setup a secure tunnel to %I
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Environment</span><span class="token operator">=</span><span class="token string">&quot;LOCAL_ADDR=localhost&quot;</span>
<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/etc/default/secure-tunnel@%i
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/ssh -NT -o <span class="token assign-left variable">ServerAliveInterval</span><span class="token operator">=</span><span class="token number">60</span> -o <span class="token assign-left variable">ExitOnForwardFailure</span><span class="token operator">=</span>yes -i <span class="token variable">${SSH_KEY}</span> -R <span class="token variable">${TUNNEL_PORT}</span><span class="token builtin class-name">:</span><span class="token variable">${LOCAL_ADDRESS}</span><span class="token builtin class-name">:</span><span class="token variable">${LOCAL_PORT}</span> <span class="token variable">${TARGET}</span>

<span class="token comment"># Restart every &gt;2 seconds to avoid StartLimitInterval failure</span>
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre></div><p>Now create a defaults file, which allows us to have a custom service for our dynamic service:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">nano</span> /etc/default/secure-tunnel@foo_example_com
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">TARGET</span><span class="token operator">=</span>tunnel@example.com
<span class="token assign-left variable">LOCAL_ADDRESS</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1
<span class="token assign-left variable">LOCAL_PORT</span><span class="token operator">=</span><span class="token number">8080</span>
<span class="token assign-left variable">TUNNEL_PORT</span><span class="token operator">=</span><span class="token number">3334</span>
<span class="token assign-left variable">SSH_KEY</span><span class="token operator">=</span>/home/user/.ssh/id_rsa_foo_example_com
</code></pre></div><p>Enable the service:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> secure-tunnel@foo_example_com
</code></pre></div><p>If all went fine, now you have a SSH reverse tunnel from the AWS instance to your Raspberry PI.</p> <h4 id="what-is-going-on"><a href="#what-is-going-on" class="header-anchor">#</a> What is going on?</h4> <p>Every request to <code>foo.example.com</code> is going to the AWS instance (<code>1.1.1.1</code>), once there, NGINX is redirecting it <code>localhost:3334</code>. The Raspberry Pi has a reverse SSH tunnel which links the AWS instance port <code>3334</code> to the Raspberry Pi port <code>8080</code>. This means, when you visit <code>foo.example.com</code> you'll end in the port <code>8080</code> of your Raspberry Pi.</p> <div class="language- extra-class"><pre class="language-text"><code>foo.example.com &lt;------&gt; Raspberry Pi port 8080
</code></pre></div><h3 id="test"><a href="#test" class="header-anchor">#</a> Test</h3> <p>Launch a static server in your Raspberry Pi:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ python -m SimpleHTTPServer <span class="token number">8080</span>
</code></pre></div><p>Now, if you visit <code>foo.example.com</code>, you'll see the content served by the Raspberry Pi on port 8080 through the Python static server we just run.</p> <h3 id="adding-more-services"><a href="#adding-more-services" class="header-anchor">#</a> Adding more services</h3> <p>This is pretty simple now:</p> <p>Create a new <code>A</code> entry for your domain, pointing to the AWS instance, for example <code>bar.example.com</code>.</p> <div class="language- extra-class"><pre class="language-text"><code>example.com      A  1.1.1.1
foo.example.com  A  1.1.1.1
bar.example.com  A  1.1.1.1
</code></pre></div><p>Add a new NGINX server listening to a different domain (<code>bar.example.com</code>) and redirecting to a different port. Instead of <code>3334</code> use <code>3335</code> for example. Reload the NGINX configuration.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">cp</span> /etc/nginx/sites-enabled/foo_example_com /etc/nginx/sites-enabled/bar_example_com
<span class="token comment"># Replace the values for the new service (subdomain and localhost port)</span>
$ <span class="token function">sudo</span> <span class="token function">nano</span> /etc/nginx/sites-enabled/bar_example_com
$ <span class="token function">sudo</span> nginx -s reload
</code></pre></div><p>Create a new service file in your Raspberry Pi, <code>/etc/default/secure-tunnel@bar_example_com</code> and replace <code>TUNNEL_PORT</code> by <code>3335</code> and <code>LOCAL_PORT</code> by the port of the new service. Enable the service and start it.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">sudo</span> <span class="token function">cp</span> /etc/default/secure-tunnel@foo_example_com /etc/default/secure-tunnel@bar_example_com
<span class="token comment"># Replace tunnel port and local port</span>
$ <span class="token function">sudo</span> <span class="token function">nano</span> /etc/default/secure-tunnel@bar_example_com
$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> secure-tunnel@bar_example_com
$ <span class="token function">sudo</span> systemctl start secure-tunnel@bar_example_com
</code></pre></div><h3 id="tls-and-security-notes"><a href="#tls-and-security-notes" class="header-anchor">#</a> TLS and security notes</h3> <p>Right now, you configured an architecture which works for HTTP requests, if you want to use HTTPS you'll need a certificate, configure NGINX and (probably) configure your service. The purpose of this tutorial is not to cover security concerns, just showing how to implement the solution. Security can be larger than expected to explain, but if you really know what it is, then you'll have no problem to configure it.</p> <p>Besides that, the tunnel is secure (SSH) and your Raspberry is not exposed at all, we are mapping ports from a remote AWS instance to a local port in your Raspberry, also, we are using the user <code>tunnel</code> which has limited privileges and has <code>/bin/false</code> as user's shell.</p> <h3 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h3> <p>As we can see, there is at least an alternative to Ngrok and for people that can't use DDNS, people under a NAT or just curious people, all of them  can expose services in a secure way.</p> <!----></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5ee03c05.js" defer></script><script src="/assets/js/2.d5fc9d08.js" defer></script><script src="/assets/js/8.8a89244c.js" defer></script>
  </body>
</html>
